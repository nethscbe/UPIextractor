<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPI QR → UPI ID Extractor</title>
  <style>
    :root{--bg:#0b1020;--card:#121934;--accent:#4cc9f0;--muted:#a0a6c3;--ok:#22c55e;--err:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(120deg,#0b1020,#121934 50%,#0b1020);color:#e6e9ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:1.25rem;margin:0;letter-spacing:.2px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.25);backdrop-filter: blur(6px);border-radius:18px;padding:16px}
    .controls{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.controls{grid-template-columns:1.15fr .85fr}}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{font-size:.9rem;color:var(--muted)}
    input[type=file],select,button{background:#0e1634;color:#e6e9ff;border:1px solid rgba(255,255,255,.14);padding:10px 12px;border-radius:12px}
    button{cursor:pointer;transition:.2s transform,.2s background}
    button:hover{transform:translateY(-1px)}
    button.primary{background:var(--accent);color:#051220;border:none}
    button.ghost{background:transparent}
    video,canvas{width:100%;max-height:380px;border-radius:14px;background:#030712;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){.grid{grid-template-columns:1.1fr .9fr}}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:.8rem;color:var(--muted)}
    .good{color:var(--ok)} .bad{color:var(--err)}
    .out{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0c112b;border-radius:12px;border:1px solid rgba(255,255,255,.1);padding:12px;white-space:pre-wrap;word-break:break-all}
    .pair{display:grid;grid-template-columns:140px 1fr;gap:8px;margin:8px 0}
    .copy{float:right;margin-left:8px}
    .hint{font-size:.9rem;color:var(--muted)}
    footer{opacity:.8;font-size:.85rem;margin-top:18px;color:var(--muted)}
    a{color:#9bd2ff}
  </style>
  <script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>UPI QR → UPI ID Extractor</h1>
      <span class="badge">No server · All in your browser</span>
    </header>

    <div class="grid">
      <section class="card">
        <div class="controls">
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="row" style="gap:10px">
                <button id="startCam" class="primary">Start Camera</button>
                <button id="stopCam" class="ghost">Stop</button>
              </div>
              <div class="row">
                <label for="deviceSel">Camera</label>
                <select id="deviceSel"></select>
              </div>
            </div>
            <div class="hint" style="margin-top:6px">Tip: On phones, prefer the “back” camera for faster autofocus.</div>
          </div>

          <div>
            <div class="row" style="justify-content:space-between">
              <label for="imgFile">Or choose an image (PNG/JPG/WebP)</label>
              <input id="imgFile" type="file" accept="image/*" />
            </div>
            <div class="row" style="justify-content:flex-end">
              <button id="takeShot" class="ghost">Capture Frame → Decode</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <video id="video" playsinline muted></video>
          <canvas id="canvas" hidden></canvas>
        </div>

        <div id="scanStatus" class="hint" style="margin-top:8px">Status: idle</div>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0;font-size:1.05rem">Result</h2>
          <div>
            <button id="copyUpi" class="copy">Copy UPI ID</button>
            <button id="copyPayload" class="copy">Copy Full Payload</button>
            <button id="resetResult" class="copy">Reset</button>
          </div>
        </div>
        <div class="pair"><div>UPI ID (VPA)</div><div id="upiOut" class="out">—</div></div>
        <div class="pair"><div>Raw Payload</div><div id="rawOut" class="out">—</div></div>
        <div class="pair"><div>Notes</div><div id="notes" class="hint">Supports camera or image upload. Extracts <code>pa=</code> from <code>upi://pay?...</code> strings or falls back to anything that looks like <code>name@bank</code>.</div></div>
      </section>
    </div>

    <footer>
      Works locally in your browser. If the camera fails to start, check site permissions for camera access, then refresh.
    </footer>
  </div>

<script>
(function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const startBtn = document.getElementById('startCam');
  const stopBtn = document.getElementById('stopCam');
  const deviceSel = document.getElementById('deviceSel');
  const fileInput = document.getElementById('imgFile');
  const takeShotBtn = document.getElementById('takeShot');
  const upiOut = document.getElementById('upiOut');
  const rawOut = document.getElementById('rawOut');
  const copyUpi = document.getElementById('copyUpi');
  const copyPayload = document.getElementById('copyPayload');
  const resetResult = document.getElementById('resetResult');
  const statusEl = document.getElementById('scanStatus');

  let stream = null;
  let codeReader = null;
  let currentDeviceId = null;

  function setStatus(msg){ statusEl.textContent = 'Status: ' + msg }
  function setResult(payload){
    rawOut.textContent = payload || '—';
    const upi = extractUpiId(payload || '');
    upiOut.textContent = upi || '—';
    if(upi){ setStatus('Decoded ✓'); } else { setStatus('Decoded (could not find UPI ID)'); }
  }
  function resetOutput(){
    upiOut.textContent = '—';
    rawOut.textContent = '—';
    setStatus('idle');
  }

  function extractUpiId(text){
    if(!text) return '';
    try {
      if(text.toLowerCase().startsWith('upi://')){
        const fake = new URL(text.replace(/^upi:/i,'https:'));
        const pa = fake.searchParams.get('pa');
        if(pa) return decodeURIComponent(pa);
      }
    } catch(e) { }
    const mPa = text.match(/(?:^|[?&])pa=([^&]+)/i);
    if(mPa) {
      try { return decodeURIComponent(mPa[1]); } catch { return mPa[1]; }
    }
    const vpa = text.match(/[A-Za-z0-9._-]{2,}@[A-Za-z][A-Za-z0-9]{1,}/);
    if(vpa) return vpa[0];
    return '';
  }

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      deviceSel.innerHTML = '';
      cams.forEach((d,i)=>{
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `Camera ${i+1}`;
        deviceSel.appendChild(opt);
      });
      if(cams.length>0) currentDeviceId = cams[0].deviceId;
    }catch(err){ console.error(err); }
  }

  async function startCamera(){
    try{
      setStatus('starting camera…');
      await listCameras();
      const constraints = currentDeviceId ? { video: { deviceId: { exact: currentDeviceId } }, audio:false }
        : { video: { facingMode: { ideal: 'environment' } }, audio:false };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      setStatus('camera ready');
    }catch(err){
      console.error(err);
      setStatus('camera error: ' + (err.message||err));
      alert('Camera error: ' + (err.message||err));
    }
  }

  async function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    video.pause(); video.srcObject = null;
    setStatus('camera stopped');
  }

  async function decodeCurrentFrame(){
    if(!codeReader) codeReader = new ZXing.BrowserQRCodeReader();
    if(stream && video.readyState >= 2){
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const dataUrl = canvas.toDataURL('image/png');
      try{
        const res = await codeReader.decodeFromImageUrl(dataUrl);
        if(res && res.text){ setResult(res.text); return true; }
      }catch(e){ }
    }
    return false;
  }

  async function decodeFile(file){
    if(!file) return;
    if(!codeReader) codeReader = new ZXing.BrowserQRCodeReader();
    setStatus('decoding image…');
    const url = URL.createObjectURL(file);
    try{
      const res = await codeReader.decodeFromImageUrl(url);
      if(res && res.text){ setResult(res.text); }
      else { setStatus('no QR found in image'); }
    }catch(err){
      setStatus('decode failed');
      alert('Could not decode QR from this image. Try a clearer photo.');
    } finally {
      URL.revokeObjectURL(url);
    }
  }

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);
  deviceSel.addEventListener('change', (e)=>{ currentDeviceId = e.target.value; if(stream) { stopCamera(); startCamera(); } });
  fileInput.addEventListener('change', (e)=> decodeFile(e.target.files[0]));
  takeShotBtn.addEventListener('click', decodeCurrentFrame);
  copyUpi.addEventListener('click', async ()=>{
    const text = upiOut.textContent.trim();
    if(!text || text==='—'){ alert('No UPI ID to copy yet.'); return; }
    try{ await navigator.clipboard.writeText(text); setStatus('UPI ID copied ✓'); }catch{ alert('Copy failed'); }
  });
  copyPayload.addEventListener('click', async ()=>{
    const text = rawOut.textContent.trim();
    if(!text || text==='—'){ alert('No payload to copy yet.'); return; }
    try{ await navigator.clipboard.writeText(text); setStatus('Payload copied ✓'); }catch{ alert('Copy failed'); }
  });
  resetResult.addEventListener('click', resetOutput);

  if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){
    navigator.mediaDevices.enumerateDevices().then(()=>listCameras());
  }
})();
</script>
</body>
</html>
